<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uƒçitavanje slika - DC</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
</head>
<body>
<div class="container mt-5">
    <h2>Upload Images</h2>
    <p>Capture at least 4 images.</p>

    <video id="cameraStream" width="100%" autoplay></video>
    <canvas id="imageCapture" style="display:none;"></canvas>

    <button class="btn btn-primary mt-3" onclick="captureImage()">Capture</button>
    <button class="btn btn-success mt-3" onclick="uploadCapturedImages()">Upload</button>

    <div id="thumbnails" class="row mt-3"></div>
</div>

<script src="/static/js/uploader.js"></script>
<script>
    let capturedImages = [];

    const urlParams = new URLSearchParams(window.location.search);
    const rowId = urlParams.get('rowId');

    function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment'  // This will request the rear camera
                }
            }).then(function (stream) {
                const video = document.getElementById('cameraStream');
                video.srcObject = stream;
                video.play();
            }).catch(function (error) {
                console.error('Camera access error:', error);
                alert("Unable to access the rear camera.");
            });
        } else {
            alert("Camera access not supported in this browser.");
        }
    }

    function captureImage() {
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('imageCapture');
        const thumbnails = document.getElementById('thumbnails');

        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

        const imageData = canvas.toDataURL('image/png');
        capturedImages.push(imageData);

        // Show thumbnail
        const thumbnail = document.createElement('img');
        thumbnail.src = imageData;
        thumbnail.width = 60;
        thumbnail.height = 60;
        thumbnail.className = 'mr-2 mb-2';

        thumbnails.appendChild(thumbnail);

        if (capturedImages.length >= 4) {
            document.querySelector('.btn-success').disabled = false;
        }
    }

    startCamera();

    function uploadCapturedImages() {
        const formData = new FormData();

        capturedImages.forEach((imageData, index) => {
            const byteString = atob(imageData.split(',')[1]);
            const arrayBuffer = new ArrayBuffer(byteString.length);
            const uint8Array = new Uint8Array(arrayBuffer);
            for (let i = 0; i < byteString.length; i++) {
                uint8Array[i] = byteString.charCodeAt(i);
            }

            const blob = new Blob([uint8Array], {type: 'image/png'});
            const blobFilename = `image_${index + 1}.png`;  // Example filename: image_1.png, image_2.png, etc.
            formData.append('images[]', blob, blobFilename);  // Append blob with filename
        });

        formData.append('rowId', rowId);

        fetch('/api/submit-images', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert("Images uploaded successfully!");
                } else {
                    alert("Error uploading images.");
                }
            })
            .catch(error => {
                console.error('Error uploading images:', error);
                alert("Error uploading images.");
            });
    }


</script>
</body>
</html>
