<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Live Pattern Recognition</title>
    <style>
        #container {
            position: relative;
            width: 640px; /* Set the width to your video width */
            height: 480px; /* Set the height to your video height */
        }

        #camera, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* This will stretch them to the container size */
            height: 100%;
        }

    </style>
</head>
<body>
<div id="container">
    <video id="camera" width="640" height="480" autoplay></video>
    <canvas id="overlay" width="640" height="480"></canvas>
</div>
<button id="switchCamera">Switch Camera</button>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentCamera = 0;
        let availableCameras = [];
        let cameraStream = null;

        // Function to switch the camera
        function switchCamera() {
            console.log("Camera switch button clicked.");
            if (cameraStream) {
                // Stop all video tracks before switching
                cameraStream.getTracks().forEach(track => track.stop());
            }

            // Use the next camera in the list
            currentCamera = (currentCamera + 1) % availableCameras.length;
            startCamera(availableCameras[currentCamera].deviceId);
        }

        // Function to start the camera
        function startCamera(deviceId) {
            navigator.mediaDevices.getUserMedia({video: {deviceId: deviceId ? {exact: deviceId} : undefined}})
                .then(stream => {
                    const camera = document.getElementById('camera');
                    camera.srcObject = stream;
                    cameraStream = stream;

                    camera.onloadedmetadata = () => {
                        const canvas = document.createElement("canvas");
                        canvas.width = camera.videoWidth;
                        canvas.height = camera.videoHeight;

                        processCameraStream();
                    };
                })
                .catch(error => {
                    console.error('Error accessing the camera:', error);
                });
        }


        // Function to process camera stream
        function processCameraStream() {
            const camera = document.getElementById("camera");
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = 640;
            canvas.height = 480;

            setInterval(() => {
                context.drawImage(camera, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(sendFrameToServer);
            }, 1000); // Process every 3 seconds
        }

        function sendFrameToServer(blob) {
            const formData = new FormData();
            formData.append("frame", blob);

            fetch("/process_frame", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data)
                    clearRectangles();
                    if (Array.isArray(data)) {
                        data.forEach((box) =>
                            drawRectangle(box.x, box.y, box.width, box.height)
                        );
                    }
                })
                .catch((error) => {
                    console.error("Error processing the frame:", error);
                });
        }

        function drawRectangle(x, y, width, height) {
            const canvas = document.getElementById("overlay");
            const context = canvas.getContext("2d");
            context.strokeStyle = "red";
            context.lineWidth = 5;
            context.strokeRect(x, y, width, height);
        }

        function clearRectangles() {
            const canvas = document.getElementById("overlay");
            const context = canvas.getContext("2d");
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Initialize and get the list of available video input devices (cameras)
        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                if (availableCameras.length > 0) {
                    startCamera(availableCameras[currentCamera].deviceId);
                }
            })
            .catch(error => {
                console.error('Error listing cameras:', error);
            });

        // Event listener for the camera switch button
        document.getElementById('switchCamera').addEventListener('click', switchCamera);
    });


</script>
</body>
</html>
