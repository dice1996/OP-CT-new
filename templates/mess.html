{% extends "base.html" %}

{% block title %}Poruke - {{ session.name }}{% endblock %}

{% block additional_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #00ffb2;
            color: dimgrey;
            text-align: center;
            line-height: 50px;
            font-size: 24px;
            margin-right: 10px;
        }

        .my-message {
            background-color: #007BFF;
            color: white;
            text-align: right;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            align-self: flex-end;
        }

        .customer-message {
            background-color: #E0E0E0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .conversation-item {
            display: flex; /* Add this line */
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
        }

        .conversation-item:hover {
            background-color: #f2f2f2;
        }

        .timestamp {
            color: gray;
            font-size: 12px;
            text-align: right;
        }


    </style>
{% endblock %}

{% block additional_js_after %}

    <script>
        let conversations = {};

        async function loadConversations() {
            // Replace 'YOUR_API_SECRET' with the actual API secret
            const apiSecret = '13267bddcdbc802f5b390d50cb227e88e78b7b36';

            try {
                // Fetch received messages
                const receivedRes = await fetch(`https://www.cloud.smschef.com/api/get/sms.received?secret=${apiSecret}`);
                const receivedData = await receivedRes.json();

                if (receivedData.status !== 200) {
                    throw new Error('Failed to fetch received messages');
                }

                // Populate 'conversations' with received messages
                receivedData.data.forEach(msg => {
                    const number = msg.sender;
                    if (!conversations[number]) {
                        conversations[number] = [];
                    }
                    conversations[number].push({
                        message: msg.message,
                        type: 'customer',
                        timestamp: msg.created
                    });
                });

                // Fetch sent messages
                const sentRes = await fetch(`https://www.cloud.smschef.com/api/get/sms.sent?secret=${apiSecret}`);
                const sentData = await sentRes.json();

                if (sentData.status !== 200) {
                    throw new Error('Failed to fetch sent messages');
                }

                // Populate 'conversations' with sent messages
                sentData.data.forEach(msg => {
                    const number = msg.recipient;
                    if (!conversations[number]) {
                        conversations[number] = [];
                    }
                    conversations[number].push({
                        message: msg.message,
                        type: 'my',
                        timestamp: msg.created
                    });
                });

                // Sort conversations by the timestamp of the last message in each
                const sortedNumbers = Object.keys(conversations).sort((a, b) => {
                    const lastMsgA = conversations[a][conversations[a].length - 1];
                    const lastMsgB = conversations[b][conversations[b].length - 1];
                    return lastMsgB.timestamp - lastMsgA.timestamp;
                });

                const sortedConversations = {};
                sortedNumbers.forEach(number => {
                    sortedConversations[number] = conversations[number];
                });

                conversations = sortedConversations;
                renderConversationsList(conversations);

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        loadConversations();
        let currentChat = null;

        // Function to render the list of conversations
        function renderConversationsList() {
            const conversationList = document.getElementById('conversation_list');
            conversationList.innerHTML = '';

            // Convert the conversations object to an array and sort it
            const sortedConversations = Object.entries(conversations).sort((a, b) => {
                const lastMessageA = a[1][a[1].length - 1].timestamp;
                const lastMessageB = b[1][b[1].length - 1].timestamp;
                return lastMessageB - lastMessageA; // Sort in descending order
            });

            for (const [number, messages] of sortedConversations) {
                const lastMessage = messages[messages.length - 1];
                const listItem = document.createElement('li');
                listItem.className = 'conversation-item';

                // New wrapper div
                const leftWrapper = document.createElement('div');
                leftWrapper.style.flexGrow = '1';
                leftWrapper.style.display = 'flex';
                leftWrapper.style.alignItems = 'center';

                // Avatar
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = number.charAt(0).toUpperCase() + number.charAt(1).toUpperCase();
                leftWrapper.appendChild(avatar);  // Append to wrapper

                // Conversation details
                const conversationDetails = document.createElement('div');
                conversationDetails.className = 'conversation-details';

                const phoneNumber = document.createElement('div');
                phoneNumber.textContent = number;
                phoneNumber.style = "font-weight: bold;";
                conversationDetails.appendChild(phoneNumber);

                const lastMsg = document.createElement('div');

                // Truncate the message to 15 characters and append '...' if longer
                let messageText = lastMessage.message;
                if (messageText.length > 20) {
                    messageText = messageText.substring(0, 20) + '...';
                }

                lastMsg.textContent = messageText;
                lastMsg.className = 'last-message';
                conversationDetails.appendChild(lastMsg);
                leftWrapper.appendChild(conversationDetails);  // Append to wrapper

                // Append wrapper to listItem
                listItem.appendChild(leftWrapper);

                // Timestamp
                const timestamp = document.createElement('div');
                timestamp.className = 'timestamp';

                const formattedDate = formatTimestamp(lastMessage.timestamp);
                timestamp.textContent = formattedDate;
                listItem.appendChild(timestamp);

                listItem.addEventListener('click', () => {
                    currentChat = number;
                    renderMessages(number);
                    document.getElementById('chat_header').textContent = `Razgovor s ${number}`;
                });

                conversationList.appendChild(listItem);
            }
        }

        // Function to render messages for a specific conversation
        function renderMessages(number) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            conversations[number].forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ' + (msg.type === 'my' ? 'my-message' : 'customer-message');
                messageDiv.textContent = msg.message;
                messagesDiv.appendChild(messageDiv);
            });
        }

        // Function to format timestamp
        function formatTimestamp(timestamp) {
            const messageDate = new Date(timestamp * 1000);
            const currentDate = new Date();
            const diffInDays = Math.floor((currentDate - messageDate) / (1000 * 60 * 60 * 24));

            let formattedDate;
            if (diffInDays === 0) {
                formattedDate = messageDate.toTimeString().substr(0, 5);
            } else if (diffInDays < 3) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                formattedDate = days[messageDate.getDay()];
            } else {
                formattedDate = `${messageDate.toDateString().split(' ')[1]} ${messageDate.getDate()}. ${messageDate.toTimeString().substr(0, 5)}`;
            }

            return formattedDate;
        }

        // Initialize
        renderConversationsList();
    </script>

{% endblock %}


{% block additional_js_before %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
    <div class="row justify-content-center" style="margin-left: auto;">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-4">
                        </div>
                        <div class="col-md-4">
                            <div class="page-header header" style="padding-bottom: 30px">
                                <h2>
                                    PORUKE <small style="font-size: 15px;">(u izradi)</small>
                                </h2>
                                <p class="lead">
                                    Sustav slanja i primanja SMS poruka.
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-2"></div>
                            <div class="col-md-8 justify-content-end align-items-center">
                                <div class="container d-flex">
                                    <div class="sidebar flex-grow-1 border-end py-2" style="flex: 3;">
                                        <h3 class="w-100">Razgovori</h3>
                                        <ul id="conversation_list" class="list-unstyled overflow-auto"
                                            style="max-height: 450px;">
                                            <!-- List of conversations will go here -->
                                        </ul>
                                    </div>
                                    <div class="chat-window flex-grow-3 py-2" style="flex: 2;">
                                        <h3 id="chat_header" class="bg-light p-2 border-bottom">Odaberi razgovor</h3>
                                        <div id="messages" class="border rounded p-2 overflow-auto"
                                             style="height: 400px;">
                                            <!-- Messages will go here -->
                                        </div>
                                        <div class="bg-light p-2 border-top d-flex align-items-center mt-2">
                                            <input type="text" id="message_text" class="form-control me-2"
                                                   placeholder="Type a message...">
                                            <button id="send_button" class="btn btn-primary">Send</button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="col-md-2"></div>
                </div>
                <div class="col-md-4">
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

{% endblock %}